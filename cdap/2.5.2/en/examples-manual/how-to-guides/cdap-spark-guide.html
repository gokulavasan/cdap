<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2014 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Iterative Data Processing with Apache Spark &mdash; Cask Data Application Platform 2.5.2 Documentation</title>
    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.5.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.5.2 Documentation" href="../index.html" />
    <link rel="up" title="How-To Guides" href="index.html" />
    <link rel="next" title="Tutorials" href="../tutorials.html" />
    <link rel="prev" title="Consuming Twitter Data in Realtime" href="cdap-twitter-ingest-guide.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../tutorials.html" title="Tutorials"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="cdap-twitter-ingest-guide.html" title="Consuming Twitter Data in Realtime"
             accesskey="P">Previous</a> |</li>
        <li><a href="../table-of-contents.html">CDAP Examples, Guides, and Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-To Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="iterative-data-processing-with-apache-spark">
<span id="cdap-spark-guide"></span><h1>Iterative Data Processing with Apache Spark<a class="headerlink" href="#iterative-data-processing-with-apache-spark" title="Permalink to this headline">¶</a></h1>
<blockquote class="pull-quote">
<div><strong>Source Code Repository:</strong> Source code (and other resources) for this guide are available at the
<a class="reference external" href="https://github.com/cdap-guides/cdap-spark-guide">CDAP Guides GitHub repository</a>.</div></blockquote>
<p><a class="reference external" href="https://spark.apache.org/">Apache Spark</a> is a very popular engine to
perform in-memory cluster computing for Apache Hadoop. In this guide,
you will learn how to run Apache Spark programs with CDAP.</p>
<div class="section" id="what-you-will-build">
<h2>What You Will Build<a class="headerlink" href="#what-you-will-build" title="Permalink to this headline">¶</a></h2>
<p>You will build a <a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/applications.html">CDAP
application</a>
that exposes a REST API to take in web pages’ backlinks information and
serve out the <a class="reference external" href="http://en.wikipedia.org/wiki/PageRank">PageRank</a> for
the known web pages. You will:</p>
<ul class="simple">
<li>Build a CDAP
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/spark-jobs.html">Spark</a>
program that computes the PageRank of the web pages;</li>
<li>Build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/services.html">Service</a>
to receive backlinks data and serve the PageRank computation results
over HTTP;</li>
<li>Use a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/datasets/index.html">Dataset</a>
to store the input data; and</li>
<li>Use a Dataset as input and output for the Spark program.</li>
</ul>
</div>
<div class="section" id="what-you-will-need">
<h2>What You Will Need<a class="headerlink" href="#what-you-will-need" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 6 or JDK
7</a></li>
<li><a class="reference external" href="http://maven.apache.org/">Apache Maven 3.0+</a></li>
<li><a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/getting-started/standalone/index.html">CDAP
SDK</a></li>
</ul>
</div>
<div class="section" id="lets-build-it">
<h2>Let’s Build It!<a class="headerlink" href="#lets-build-it" title="Permalink to this headline">¶</a></h2>
<p>The following sections will guide you through building an application
from scratch. If you are interested in deploying and running the
application right away, you can clone its source code from this GitHub
repository. In that case, feel free to skip the next two sections and
jump right to the <a class="reference external" href="#build-and-run-application">Build and Run
Application</a> section.</p>
<div class="section" id="application-design">
<h3>Application Design<a class="headerlink" href="#application-design" title="Permalink to this headline">¶</a></h3>
<p>Backlinks data is sent to the <em>PageRankService</em> over HTTP (e.g. by a web
crawler as it processes web pages). The service persists the data into a
<em>backLinks</em> dataset upon receiving it. The PageRank for known pages is
computed periodically by a <em>PageRankProgram</em>. The program uses the
<em>backLinks</em> dataset as an input and persists the results in the
<em>pageRanks</em> dataset.</p>
<p>The <em>PageRankService</em> then uses the <em>pageRanks</em> dataset to serve the
PageRank for a given URL over HTTP.</p>
<p>In this guide we assume that the backlinks data will be sent to a CDAP
application.</p>
<div class="figure">
<img alt="" src="../_images/app-design4.png" />
</div>
</div>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>The first step is to construct the application structure. We will use a
standard Maven project structure for all of the source code files:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">./pom.xml</span>
<span class="go">./src/main/java/co/cask/cdap/guides/BackLinksHandler.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankApp.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankSpark.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageRankHandler.java</span>
<span class="go">./src/main/scala/co/cask/cdap/guides/PageRankProgram.scala</span>
</pre></div>
</div>
<p>The application is identified by the <tt class="docutils literal"><span class="pre">PageRankApp</span></tt> class. This class
extends
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/app/AbstractApplication.html">AbstractApplication</a>,
and overrides the <tt class="docutils literal"><span class="pre">configure(</span> <span class="pre">)</span></tt> method to define all of the
application components:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageRankApp</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="s">&quot;PageRankApplication&quot;</span><span class="o">);</span>
    <span class="n">addSpark</span><span class="o">(</span><span class="k">new</span> <span class="n">PageRankSpark</span><span class="o">());</span>
    <span class="n">addService</span><span class="o">(</span><span class="s">&quot;PageRankService&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">ImmutableList</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">HttpServiceHandler</span><span class="o">&gt;()</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">BackLinksHandler</span><span class="o">())</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PageRankHandler</span><span class="o">())</span>
      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">ObjectStores</span><span class="o">.</span><span class="na">createObjectStore</span><span class="o">(</span><span class="n">getConfigurer</span><span class="o">(),</span> <span class="s">&quot;backLinks&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="n">ObjectStores</span><span class="o">.</span><span class="na">createObjectStore</span><span class="o">(</span><span class="n">getConfigurer</span><span class="o">(),</span> <span class="s">&quot;pageRanks&quot;</span><span class="o">,</span> <span class="n">Double</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedTypeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Won&#39;t happen: all classes above are supported&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>In this example we’ll use Scala to write a Spark program (for an example
of using Java, refer to the <a class="reference external" href="http://docs.cask.co/cdap/current/en/developers-manual/examples/spark-page-rank.html">CDAP SparkPageRank
example</a>).
You’ll need to add <tt class="docutils literal"><span class="pre">scala</span></tt> and <tt class="docutils literal"><span class="pre">maven-scala-plugin</span></tt> as dependencies
in your Maven
<a class="reference external" href="https://github.com/cdap-guides/cdap-spark-guide/blob/develop/pom.xml">pom.xml.</a></p>
<p>The code below configures Spark in CDAP. This class extends
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/spark/AbstractSpark.html">AbstractSpark</a>
and overrides the <tt class="docutils literal"><span class="pre">configure(</span> <span class="pre">)</span></tt> method to define all of the
components. The <tt class="docutils literal"><span class="pre">setMainClassName</span></tt> method sets the Spark Program class
which CDAP will run:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageRankSpark</span> <span class="kd">extends</span> <span class="n">AbstractSpark</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">SparkSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">SparkSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">()</span>
      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;PageRankProgram&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">&quot;Spark program to compute PageRank&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setMainClassName</span><span class="o">(</span><span class="n">PageRankProgram</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">BackLinksHandler</span></tt> receives backlinks info via POST to <tt class="docutils literal"><span class="pre">backlink</span></tt>.
Valid backlink information is in the form of two URLs separated by
whitespace:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">http://example.com/page1 http://example.com/page10</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">BackLinksHandler</span></tt> stores the backlink information in an
<a class="reference external" href="http://docs.cask.co/cdap/current/en/reference-manual/javadocs/co/cask/cdap/api/dataset/lib/ObjectStore.html">ObjectStore
Dataset</a>
as a String in the format shown above:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BackLinksHandler</span> <span class="kd">extends</span> <span class="n">AbstractHttpServiceHandler</span> <span class="o">{</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;backLinks&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">ObjectStore</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">backLinks</span><span class="o">;</span>

  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;backlink&quot;</span><span class="o">)</span>
  <span class="nd">@POST</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleBackLink</span><span class="o">(</span><span class="n">HttpServiceRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServiceResponder</span> <span class="n">responder</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">ByteBuffer</span> <span class="n">requestContents</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">requestContents</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="s">&quot;Request content is empty.&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">parseAndStore</span><span class="o">(</span><span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">requestContents</span><span class="o">).</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">()))</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendStatus</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">.</span><span class="na">code</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="s">&quot;Malformed backlink information&quot;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Validates the format and stores the backlink information if valid</span>
<span class="cm">   *</span>
<span class="cm">   * @param bLink the request body</span>
<span class="cm">   * @return true if the backlink information is valid else false</span>
<span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">parseAndStore</span><span class="o">(</span><span class="n">String</span> <span class="n">bLink</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">backlinkURLs</span> <span class="o">=</span> <span class="n">bLink</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">backlinkURLs</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">backLinks</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bLink</span><span class="o">,</span> <span class="n">bLink</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">PageRankProgram</span></tt> Spark program does the actual page rank
computation. This code is taken from the <a class="reference external" href="https://github.com/apache/spark/blob/master/examples/src/main/scala/org/apache/spark/examples/SparkPageRank.scala">Apache Spark&#8217;s PageRank
example</a>;
the Spark program stores the computed PageRank in an ObjectStore Dataset
where the key is the URL and the value is the computed PageRank:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">PageRankProgram</span> <span class="kd">extends</span> <span class="n">ScalaSparkProgram</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">val</span> <span class="nl">ITERATIONS_COUNT:</span> <span class="n">Int</span> <span class="o">=</span> <span class="mi">10</span>

  <span class="n">override</span> <span class="n">def</span> <span class="nf">run</span><span class="o">(</span><span class="nl">sc:</span> <span class="n">SparkContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="nl">lines:</span> <span class="n">RDD</span><span class="o">[(</span><span class="n">Array</span><span class="o">[</span><span class="n">Byte</span><span class="o">],</span> <span class="n">String</span><span class="o">)]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">readFromDataset</span><span class="o">(</span><span class="s">&quot;backLinks&quot;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="n">Array</span><span class="o">[</span><span class="n">Byte</span><span class="o">]],</span> <span class="n">classOf</span><span class="o">[</span><span class="n">String</span><span class="o">])</span>
    <span class="n">val</span> <span class="n">links</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="n">s</span> <span class="o">=&gt;</span>
      <span class="n">val</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">_2</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">)</span>
      <span class="o">(</span><span class="n">parts</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">parts</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">}.</span><span class="na">distinct</span><span class="o">().</span><span class="na">groupByKey</span><span class="o">().</span><span class="na">cache</span><span class="o">()</span>

    <span class="n">var</span> <span class="n">ranks</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">mapValues</span><span class="o">(</span><span class="n">v</span> <span class="o">=&gt;</span> <span class="mf">1.0</span><span class="o">)</span>

    <span class="c1">// Calculate the PageRanks</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">ITERATIONS_COUNT</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">val</span> <span class="n">contribs</span> <span class="o">=</span> <span class="n">links</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">ranks</span><span class="o">).</span><span class="na">values</span><span class="o">.</span><span class="na">flatMap</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">urls</span><span class="o">,</span> <span class="n">rank</span><span class="o">)</span> <span class="o">=&gt;</span>
        <span class="n">val</span> <span class="n">size</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">size</span>
        <span class="n">urls</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">url</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">rank</span> <span class="o">/</span> <span class="n">size</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="n">ranks</span> <span class="o">=</span> <span class="n">contribs</span><span class="o">.</span><span class="na">reduceByKey</span><span class="o">(</span><span class="n">_</span> <span class="o">+</span> <span class="n">_</span><span class="o">).</span><span class="na">mapValues</span><span class="o">(</span><span class="mf">0.15</span> <span class="o">+</span> <span class="mf">0.85</span> <span class="o">*</span> <span class="n">_</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">val</span> <span class="n">output</span> <span class="o">=</span> <span class="n">ranks</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">_1</span><span class="o">),</span> <span class="n">x</span><span class="o">.</span><span class="na">_2</span><span class="o">))</span>

    <span class="n">sc</span><span class="o">.</span><span class="na">writeToDataset</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="s">&quot;pageRanks&quot;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="n">Array</span><span class="o">[</span><span class="n">Byte</span><span class="o">]],</span> <span class="n">classOf</span><span class="o">[</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Double</span><span class="o">])</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To serve results out via HTTP, add a <tt class="docutils literal"><span class="pre">PageRankHandler</span></tt>, which reads
the PageRank for a given URL from the <tt class="docutils literal"><span class="pre">pageRanks</span></tt> dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageRankHandler</span> <span class="kd">extends</span> <span class="n">AbstractHttpServiceHandler</span> <span class="o">{</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;pageRanks&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">ObjectStore</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">pageRanks</span><span class="o">;</span>

  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;pagerank&quot;</span><span class="o">)</span>
  <span class="nd">@POST</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleBackLink</span><span class="o">(</span><span class="n">HttpServiceRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServiceResponder</span> <span class="n">responder</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">ByteBuffer</span> <span class="n">requestContents</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestContents</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="s">&quot;No URL provided.&quot;</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">urlParam</span> <span class="o">=</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">requestContents</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>

    <span class="n">Double</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">pageRanks</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">urlParam</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">rank</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">responder</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="s">&quot;The following URL was not found: &quot;</span> <span class="o">+</span> <span class="n">urlParam</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">responder</span><span class="o">.</span><span class="na">sendJson</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">rank</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-and-run-application">
<h2>Build and Run Application<a class="headerlink" href="#build-and-run-application" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">PageRankApp</span></tt> application can be built and packaged using the
Apache Maven command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">mvn clean package</span>
</pre></div>
</div>
<p>Note that the remaining commands assume that the <tt class="docutils literal"><span class="pre">cdap-cli.sh</span></tt> script
is available on your PATH. If this is not the case, please add it:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">export PATH=$PATH:&lt;CDAP home&gt;/bin</span>
</pre></div>
</div>
<p>If you haven&#8217;t already started a standalone CDAP installation, start it
with the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cdap.sh start</span>
</pre></div>
</div>
<p>You can then deploy the application to a standalone CDAP installation:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cdap-cli.sh deploy app target/cdap-spark-guide-1.0.0.jar</span>
</pre></div>
</div>
<p>Start the Service:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cdap-cli.sh start service PageRankApp.PageRankService</span>
</pre></div>
</div>
<p>Send some Data:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">export BACKLINK_URL=http://localhost:10000/v2/apps/PageRankApp/services/PageRankService/methods/backlink</span>

<span class="go">curl -v -d &#39;http://example.com/page1 http://example.com/page1&#39; $BACKLINK_URL</span>
<span class="go">curl -v -d &#39;http://example.com/page1 http://example.com/page10&#39; $BACKLINK_URL</span>
<span class="go">curl -v -d &#39;http://example.com/page10 http://example.com/page10&#39; $BACKLINK_URL</span>
<span class="go">curl -v -d &#39;http://example.com/page10 http://example.com/page100&#39; $BACKLINK_URL</span>
<span class="go">curl -v -d &#39;http://example.com/page100 http://example.com/page100&#39; $BACKLINK_URL</span>
</pre></div>
</div>
<p>Run the Spark Program:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">curl -v -d &#39;http://localhost:10000/v2/apps/PageRankApp/spark/PageRankProgram/start&#39;</span>
</pre></div>
</div>
<p>The Spark Program can take time to complete. You can check the status
for completion using:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">curl -v &#39;http://localhost:10000/v2/apps/PageRankApp/spark/PageRankProgram/status&#39;</span>
</pre></div>
</div>
<p>Query for the PageRank results:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">curl -v -d &#39;http://example.com/page10&#39; &#39;http://localhost:10000/v2/apps/PageRankApp/services/PageRankService/methods/pagerank&#39;</span>
</pre></div>
</div>
<p>Example output:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">0.45521228811700043</span>
</pre></div>
</div>
<p>Congratulations! You have now learned how to incorporate Spark programs
into your CDAP applications. Please continue to experiment and extend
this sample application.</p>
</div>
<div class="section" id="share-and-discuss">
<h2>Share and Discuss!<a class="headerlink" href="#share-and-discuss" title="Permalink to this headline">¶</a></h2>
<p>Have a question? Discuss at the <a class="reference external" href="https://groups.google.com/forum/#!forum/cdap-user">CDAP User Mailing
List.</a></p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h2>
<p>Copyright © 2014 Cask Data, Inc.</p>
<p>Licensed under the Apache License, Version 2.0 (the &#8220;License&#8221;); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at</p>
<p><a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#8220;AS IS&#8221; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3>CDAP Documentation</h3>
    <ul class="this-page-menu">
      <li><a href="../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></li>
      <li><a href="../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
      <li><a href="../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
      <li><b><a href="../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></b></li>
      <li><a href="../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
      <li><a href="../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
      <li><a href="../table-of-contents/../../reference-manual/faq.html"
            rel="nofollow">FAQ</a></li>
    </ul>
   </div><!--
  Copyright © 2014 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->

<h3 class="pagenavtitle"><a href="../table-of-contents.html">Examples, Guides, and Tutorials: Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cdap-flow-guide.html">Realtime Data Processing with a Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-flume-guide.html">Ingesting Data into CDAP using Apache Flume</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-mapreduce-guide.html">Batch Data Processing With CDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-bi-guide.html">Analyzing CDAP Data from BI Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-timeseries-guide.html">Storing Timeseries Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-twitter-ingest-guide.html">Consuming Twitter Data in Realtime</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Iterative Data Processing with Apache Spark</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-build">What You Will Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-need">What You Will Need</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lets-build-it">Let’s Build It!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-and-run-application">Build and Run Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#share-and-discuss">Share and Discuss!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps-packs.html">Apps and Packs</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="cdap-twitter-ingest-guide.html"
                        title="Previous Chapter">Consuming Twitter Data in Realtime</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="../tutorials.html"
                        title="Next Chapter">Tutorials</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/2.5.2/cdap-docs-2.5.2-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Consuming Twitter Data in Realtime" href="cdap-twitter-ingest-guide.html" />Consuming Twitter Data in Realtime</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        &copy; Copyright 2014 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Tutorials" href="../tutorials.html" />Tutorials</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>