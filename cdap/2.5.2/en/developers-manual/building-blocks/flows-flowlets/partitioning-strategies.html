<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2014 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Partitioning Strategies &mdash; Cask Data Application Platform 2.5.2 Documentation</title>
    
    <link rel="stylesheet" href="../../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.5.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.5.2 Documentation" href="../../index.html" />
    <link rel="up" title="Flows and Flowlets" href="index.html" />
    <link rel="next" title="MapReduce Jobs" href="../mapreduce-jobs.html" />
    <link rel="prev" title="Flowlets and Instances" href="flowlets-instances.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../mapreduce-jobs.html" title="MapReduce Jobs"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="flowlets-instances.html" title="Flowlets and Instances"
             accesskey="P">Previous</a> |</li>
        <li><a href="../../table-of-contents.html">CDAP Developers’ Manual</a> &raquo;</li>
          <li><a href="../index.html" >Building Blocks</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Flows and Flowlets</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="partitioning-strategies">
<h1>Partitioning Strategies<a class="headerlink" href="#partitioning-strategies" title="Permalink to this headline">¶</a></h1>
<p>As mentioned above, if you have multiple instances of a Flowlet the input queue is
partitioned among the Flowlets. The partitioning can occur in different ways, and each
Flowlet can specify one of these three partitioning strategies:</p>
<ul class="simple">
<li><strong>First-in first-out (FIFO):</strong> Default mode. In this mode, every Flowlet instance
receives the next available data object in the queue. However, since multiple consumers
may compete for the same data object, access to the queue must be synchronized. This may
not always be the most efficient strategy.</li>
<li><strong>Round-robin:</strong> With this strategy, the number of items is distributed evenly among the
instances. In general, round-robin is the most efficient partitioning. Though more
efficient than FIFO, it is not ideal when the application needs to group objects into
buckets according to business logic. In those cases, hash-based partitioning is
preferable.</li>
<li><strong>Hash-based:</strong> If the emitting Flowlet annotates each data object with a hash key, this
partitioning ensures that all objects of a given key are received by the same consumer
instance. This can be useful for aggregating by key, and can help reduce write conflicts.</li>
</ul>
<p class="rubric">First-in first-out (FIFO) Partitioning</p>
<p>Suppose we have a Flowlet that counts words:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Counter</span> <span class="kd">extends</span> <span class="n">AbstractFlowlet</span> <span class="o">{</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;wordCounts&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">KeyValueTable</span> <span class="n">wordCountsTable</span><span class="o">;</span>

  <span class="nd">@ProcessInput</span><span class="o">(</span><span class="s">&quot;wordOut&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">wordCountsTable</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">word</span><span class="o">),</span> <span class="mi">1L</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This Flowlet uses the default strategy of FIFO.</p>
<p class="rubric">Round-robin Partitioning</p>
<p>To increase the throughput when this Flowlet has many instances, we can specify
round-robin partitioning:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@RoundRobin</span>
<span class="nd">@ProcessInput</span><span class="o">(</span><span class="s">&quot;wordOut&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">wordCountsTable</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">word</span><span class="o">),</span> <span class="mi">1L</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now, if we have three instances of this Flowlet, every instance will receive every third
word. For example, for the sequence of words in the sentence, “I scream, you scream, we
all scream for ice cream”:</p>
<ul class="simple">
<li>The first instance receives the words: <em>I scream scream cream</em></li>
<li>The second instance receives the words: <em>scream we for</em></li>
<li>The third instance receives the words: <em>you all ice</em></li>
</ul>
<p>The potential problem with this is that the first two instances might
both attempt to increment the counter for the word <em>scream</em> at the same time,
leading to a write conflict.</p>
<p class="rubric">Hash-based Partitioning</p>
<p>To avoid conflicts, we can use hash-based partitioning:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@HashPartition</span><span class="o">(</span><span class="s">&quot;wordHash&quot;</span><span class="o">)</span>
<span class="nd">@ProcessInput</span><span class="o">(</span><span class="s">&quot;wordOut&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">wordCountsTable</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">word</span><span class="o">),</span> <span class="mi">1L</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now only one of the Flowlet instances will receive the word <em>scream</em>, and there can be no
more write conflicts. Note that in order to use hash-based partitioning, the emitting
Flowlet must annotate each data object with the partitioning key:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Output</span><span class="o">(</span><span class="s">&quot;wordOut&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">OutputEmitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">wordOutput</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">StreamEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="c1">// emit the word with the partitioning key name &quot;wordHash&quot;</span>
  <span class="n">wordOutput</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="s">&quot;wordHash&quot;</span><span class="o">,</span> <span class="n">word</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note that the emitter must use the same name (&#8220;wordHash&#8221;) for the key that the consuming
Flowlet specifies as the partitioning key. If the output is connected to more than one
Flowlet, you can also annotate a data object with multiple hash keys—each consuming
Flowlet can then use different partitioning. This is useful if you want to aggregate by
multiple keys, such as counting purchases by product ID as well as by customer ID.</p>
<p class="rubric">Partitioning and Batch Execution</p>
<p>Partitioning can be combined with batch execution:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Batch</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="nd">@HashPartition</span><span class="o">(</span><span class="s">&quot;wordHash&quot;</span><span class="o">)</span>
<span class="nd">@ProcessInput</span><span class="o">(</span><span class="s">&quot;wordOut&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
   <span class="o">...</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3>CDAP Documentation</h3>
    <ul class="this-page-menu">
      <li><b><a href="../../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></b></li>
      <li><a href="../../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
      <li><a href="../../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
      <li><a href="../../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></li>
      <li><a href="../../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
      <li><a href="../../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
      <li><a href="../../table-of-contents/../../reference-manual/faq.html"
            rel="nofollow">FAQ</a></li>
    </ul>
   </div><!--
  Copyright © 2014 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->

<h3 class="pagenavtitle"><a href="../../table-of-contents.html">Developers’ Manual: Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html"> Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html"> Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html"> Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html"> Building Blocks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../core.html"> Core Virtualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../applications.html"> Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../streams.html"> Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="../datasets/index.html"> Datasets</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html"> Flows and Flowlets</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="flowlets.html"> Flowlets</a></li>
<li class="toctree-l3"><a class="reference internal" href="input-context.html"> Input Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="type-projection.html"> Type Projection</a></li>
<li class="toctree-l3"><a class="reference internal" href="stream-event.html"> Stream Event</a></li>
<li class="toctree-l3"><a class="reference internal" href="tick-methods.html"> Tick Methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="connecting-flowlets.html"> Connecting Flowlets</a></li>
<li class="toctree-l3"><a class="reference internal" href="batch-execution.html"> Batch Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="flowlets-instances.html"> Flowlets and Instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href=""> Partitioning Strategies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mapreduce-jobs.html"> MapReduce Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workflows.html"> Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spark-jobs.html"> Spark Jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../procedures.html"> Procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services.html"> Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../transaction-system.html"> Transaction System</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html"> Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing/index.html"> Testing and Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ingesting-tools/index.html"> Ingesting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced/index.html"> Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html"> Troubleshooting</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="flowlets-instances.html"
                        title="Previous Chapter">Flowlets and Instances</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="../mapreduce-jobs.html"
                        title="Next Chapter">MapReduce Jobs</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/2.5.2/cdap-docs-2.5.2-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Flowlets and Instances" href="flowlets-instances.html" />Flowlets and Instances</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        &copy; Copyright 2014 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="MapReduce Jobs" href="../mapreduce-jobs.html" />MapReduce Jobs</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>